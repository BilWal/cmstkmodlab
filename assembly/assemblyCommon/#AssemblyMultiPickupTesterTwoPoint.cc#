/////////////////////////////////////////////////////////////////////////////////
//                                                                             //
//               Copyright (C) 2011-2017 - The DESY CMS Group                  //
//                           All rights reserved                               //
//                                                                             //
//      The CMStkModLab source code is licensed under the GNU GPL v3.0.        //
//      You have the right to modify and/or redistribute this source code      //
//      under the terms specified in the license, which may be found online    //
//      at http://www.gnu.org/licenses or at License.txt.                      //
//                                                                             //
/////////////////////////////////////////////////////////////////////////////////

#include <nqlogger.h>
#include <ApplicationConfig.h>
#include <AssemblyMultiPickupTesterTwoPoint.h>  

AssemblyMultiPickupTesterTwoPoint::AssemblyMultiPickupTesterTwoPoint(const LStepExpressMotionManager* motion_manager, QObject* parent)
 : QObject(parent)

 , motion_manager_(motion_manager)
 , motion_manager_enabled_(false)
{
  if(motion_manager_ == nullptr)
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Critical) << "input error"
       << ": null pointer to LStepExpressMotionManager object, initialization stopped";

    return;
  }

  ApplicationConfig* config = ApplicationConfig::instance();
  if(config == nullptr)
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Fatal)
       << "ApplicationConfig::instance() not initialized (null pointer), stopped constructor";

    return;
  }

  pickup_vacuum_ = config->getValue<int>("Vacuum_PickupTool");
  pickup_basepl_ = config->getValue<int>("Vacuum_Baseplate");

  pickup_deltaZ_ = config->getValue<double>("AssemblyMultiPickupTesterTwoPoint_pickup_deltaZ", 20.); 

  use_vacuumBP_  = config->getValue<bool>("AssemblyMultiPickupTesterTwoPoint_useBaseplateVacuum");

  this->reset();

  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Debug) << "constructed";
}

AssemblyMultiPickupTesterTwoPoint::~AssemblyMultiPickupTesterTwoPoint()
{
}

void AssemblyMultiPickupTesterTwoPoint::enable_motion_manager(const bool arg)
{
  if(arg == motion_manager_enabled_)
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Debug) << "enable_motion_manager(" << arg << ")"
       << ": motion-manager for multi-pickup test already " << (arg ? "enabled" : "disabled") << ", no action taken";

    return;
  }

  if(arg)
  {
    connect(this, SIGNAL(move_relative(double, double, double, double)), motion_manager_, SLOT(moveRelative(double, double, double, double)));
    connect(motion_manager_, SIGNAL(motion_finished()), this, SLOT(setup_next_step()));

    motion_manager_enabled_ = true;

    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "enable_motion_manager(" << arg << ")"
       << ": motion-manager for multi-pickup test enabled";
  }
  else
  {
    disconnect(this, SIGNAL(move_relative(double, double, double, double)), motion_manager_, SLOT(moveRelative(double, double, double, double)));
    disconnect(motion_manager_, SIGNAL(motion_finished()), this, SLOT(setup_next_step()));

    motion_manager_enabled_ = false;

    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "enable_motion_manager(" << arg << ")"
       << ": motion-manager for multi-pickup test disabled";
  }

  return;
}

void AssemblyMultiPickupTesterTwoPoint::reset()
{
  itera_counter_ = 0;

  mode_ = AssemblyMultiPickupTesterTwoPoint::Mode_None;
  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_None;
  conf_ = AssemblyMultiPickupTesterTwoPoint::Configuration();

  vacuum_on_   = false;
  vacuumBP_on_ = true;
  pickup_done_ = false;
  picked_up_   = false;

  this->disconnect_motion_manager();
}

void AssemblyMultiPickupTesterTwoPoint::start_measurement()
{
  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Message) << "start_measurement: -------------------------------";
  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Message) << "start_measurement: initializing measurement [#" << itera_counter_ << "]";
  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Message) << "start_measurement: -------------------------------";

  mode_ = AssemblyMultiPickupTesterTwoPoint::Mode_measurement;

  const double dz = (conf_.measurement_Z() - motion_manager_->get_position_Z());

  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "start_measurement"
     << ": emitting signal \"move_relative(0, 0, " << dz << ", 0)\"";

  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_Z;

  this->connect_motion_manager();

  emit move_relative(0., 0., dz, 0.);
}

void AssemblyMultiPickupTesterTwoPoint::finish_measurement(const int exit_code)
{
  QMutexLocker ml(&mutex_);

  if(exit_code != 0)
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Critical) << "finish_measurement"
       << ": measurement terminated with non-zero exit code (" << exit_code << "). Stopping test.";

    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "finish_measurement"
       << ": emitting signal \"test_finished\"";

    this->reset();

    emit test_finished();

    return;
  }

  ++itera_counter_;

  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "finish_measurement"
     << ": emitting signal \"measurement_finished\"";

  emit measurement_finished();
}

void AssemblyMultiPickupTesterTwoPoint::start_pickup()
{
  if(itera_counter_ > conf_.iterations())
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "start_pickup"
       << ": emitting signal \"test_finished\"";

    this->reset();

    emit test_finished();

    return;
  }

  mode_ = AssemblyMultiPickupTesterTwoPoint::Mode_pickup;

  vacuum_on_   = false;
  vacuumBP_on_ = true;
  pickup_done_ = false;
  picked_up_   = false;

  const double dx = (conf_.pickup_X() - motion_manager_->get_position_X());
  const double dy = (conf_.pickup_Y() - motion_manager_->get_position_Y());

  NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "start_pickup"
     << ": emitting signal \"move_relative(" << dx << ", " << dy << ", 0, 0)\"";

  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_XY;

  this->connect_motion_manager();

  emit move_relative(dx, dy, 0., 0.);
}

void AssemblyMultiPickupTesterTwoPoint::setup_next_step()
{
  if(itera_counter_ > conf_.iterations())
  {
    NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
       << ": emitting signal \"test_finished\"";

    this->reset();

    emit test_finished();

    return;
  }
  else
  {
    if(mode_ == AssemblyMultiPickupTesterTwoPoint::Mode_measurement)
    {
      if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_Z)
      {
        const double dx = (conf_.measurement_X() - motion_manager_->get_position_X());
        const double dy = (conf_.measurement_Y() - motion_manager_->get_position_Y());

        NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
           << ": emitting signal \"move_relative(" << dx << ", " << dy << ", 0, 0)\"";

        move_ = AssemblyMultiPickupTesterTwoPoint::Movement_XY;

        this->connect_motion_manager();

        emit move_relative(dx, dy, 0., 0.);
      }
      else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_XY)
      {
        move_ = AssemblyMultiPickupTesterTwoPoint::Movement_TLPSS;

        this->disconnect_motion_manager();

        NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
           << ": emitting signal \"measurement_request\"";

        emit measurement_request();
      }

      else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_TLPSS)
	{
	  const double dy = 95.0;

	  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_MeasTLPSS;

	  this->connect_motion_manager();

	  emit move_relative(0.,-dy,0.,0.);
	}
      else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_MeasTLPSS)
	{

	  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_BLPSS;

	  this->disconnect_motion_manager();

	  emit measurement_request();
	}
      else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_BLPSS)
	{
	  const	double dy = 95.0;

          move_	= AssemblyMultiPickupTesterTwoPoint::Movement_MeasBLPSS;

          this->connect_motion_manager();

          emit move_relative(0.,-dy,0.,0.);
        }

      else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_MeasBLPSS)
	{
	  this->disconnect_motion_manager();

	  move_ = AssemblyMultiPickupTesterTwoPoint::Movement_None;
	  
	  emit measurement_request();
	}
      
      else
	{
        NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Fatal) << "setup_next_step"
           << ": logic error (Mode=measurement, Movement!=[XY,Z]), terminating test";

        NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
           << ": emitting signal \"test_finished\"";

        this->reset();

        emit test_finished();

        return;
      }
    }
    else if(mode_ == AssemblyMultiPickupTesterTwoPoint::Mode_pickup)
    {
      if(pickup_done_ == true)
      {
        if(picked_up_ == true)
        {
          NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Critical) << "setup_next_step"
             << ": logic error: [mode=pickup] pickup completed, but picked_up switch still ON. Stopping test.";

          NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
             << ": emitting signal \"test_finished\"";

          this->reset();

          emit test_finished();

          return;
        }
        else
        {
          if(use_vacuumBP_ && vacuumBP_on_ == false)
          {
            vacuumBP_on_ = true;

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"vacuum_toggle(" << pickup_basepl_ << ")\"";

            emit vacuum_toggle(pickup_basepl_);
          }
          else if(vacuum_on_ == true)
          {
            vacuum_on_ = false;

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"vacuum_toggle(" << pickup_vacuum_ << ")\"";

            emit vacuum_toggle(pickup_vacuum_);
          }
          else
          {
            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"pickup_finished\"";

            move_ = AssemblyMultiPickupTesterTwoPoint::Movement_None;

            this->disconnect_motion_manager();

            emit pickup_finished();
          }
        }
      }
      else
      {
        if(picked_up_ == false && (vacuum_on_ == false || (use_vacuumBP_ && vacuumBP_on_ == true)))
        {
          if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_XY)
          {
            const double dz = (conf_.pickup_Z() - motion_manager_->get_position_Z());

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"move_relative(0, 0, " << dz << ", 0)\"";

            move_ = AssemblyMultiPickupTesterTwoPoint::Movement_Z;

            this->connect_motion_manager();

            emit move_relative(0., 0., dz, 0.);
          }
          else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_Z)
          {
            move_ = AssemblyMultiPickupTesterTwoPoint::Movement_None;

            this->disconnect_motion_manager();

            vacuum_on_ = true;

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"vacuum_toggle(" << pickup_vacuum_ << ")\"";

            emit vacuum_toggle(pickup_vacuum_);
          }
          else if(move_ == AssemblyMultiPickupTesterTwoPoint::Movement_None)
          {
            this->disconnect_motion_manager();

            vacuumBP_on_ = false;

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"vacuum_toggle(" << pickup_basepl_ << ")\"";

            emit vacuum_toggle(pickup_basepl_);
          }
          else
          {
            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Fatal) << "setup_next_step"
               << ": logic error (Mode=pickup, Movement!=[XY,Z]), terminating test";

            NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
               << ": emitting signal \"test_finished\"";

            this->reset();

            emit test_finished();

            return;
          }
        }
        else if(picked_up_ == false && vacuum_on_ == true)
        {
          picked_up_ = true;

          const double dz = +1.0 * pickup_deltaZ_; 

          NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
             << ": emitting signal \"move_relative(0, 0, " << dz << ", 0)\"";

          move_ = AssemblyMultiPickupTesterTwoPoint::Movement_Z;

          this->connect_motion_manager();

          emit move_relative(0., 0., dz, 0.);
        }
        else if(picked_up_ == true && vacuum_on_ == true)
        {
          picked_up_ = false;

          pickup_done_ = true;

          const double dz = -1.0 * pickup_deltaZ_;

          NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
             << ": emitting signal \"move_relative(0, 0, " << dz << ", 0)\"";

          move_ = AssemblyMultiPickupTesterTwoPoint::Movement_Z;

          this->connect_motion_manager();

          emit move_relative(0., 0., dz, 0.);
        }
      }
    }
    else
    {
      NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Critical) << "setup_next_step"
         << ": logic error: undefined value for AssemblyMultiPickupTesterTwoPoint mode. Stopping test.";

      NQLog("AssemblyMultiPickupTesterTwoPoint", NQLog::Spam) << "setup_next_step"
         << ": emitting signal \"test_finished\"";

      this->reset();

      emit test_finished();

      return;
    }
  }

  return;
}
